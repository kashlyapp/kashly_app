name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

  # opcional: imprimir versió de Flutter
  #- name: Flutter version
  #  run: flutter --version

      - name: Pub get
        run: flutter pub get

      - name: Analyze
        run: dart analyze

      # IMPORTANT: instal·lar lcov ABANS de llegir coverage (si no està present)
      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Test with coverage
        run: flutter test --coverage


      - name: Enforce coverage ≥ 70%
        shell: bash
        run: |
          set -euo pipefail
          THRESHOLD=70
          TRACE="coverage/lcov.info"

          # Comprova que hi ha cobertura
          test -f "$TRACE" || { echo "Error: $TRACE not found (did you run tests with --coverage?)."; exit 1; }

          # Normalitza cobertura: filtra a lib/ i exclou generats; ignora 'empty/unused'
          lcov --extract "$TRACE" "$(pwd)/lib/*" -o "$TRACE" --ignore-errors empty,unused || true
          lcov --remove  "$TRACE" "$(pwd)/lib/**.g.dart" "$(pwd)/lib/firebase_options.dart" -o "$TRACE" --ignore-errors empty,unused || true

          echo "::group::lcov summary"
          lcov --summary "$TRACE" || true
          echo "::endgroup::"

          # Extreu el % de línies del summary
          PCT="$(lcov --summary "$TRACE" 2>/dev/null | awk '/^ *lines\\.*:/ {gsub(\"%\",\"\",$2); print $2; exit}')"
          [ -n "$PCT" ] || { echo "Parse error: no 'lines' in summary (did tests hit lib/*?)"; exit 1; }

          # Compara amb el llindar
          awk -v p="$PCT" -v t="$THRESHOLD" 'BEGIN{exit (p+0 < t+0)}' \
            && echo "✅ Coverage ${PCT}% ≥ ${THRESHOLD}% (pass)" \
            || { echo "❌ Coverage ${PCT}% < ${THRESHOLD}% (fail)"; exit 1; }
