name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

  # opcional: imprimir versió de Flutter
  #- name: Flutter version
  #  run: flutter --version

      - name: Pub get
        run: flutter pub get

      - name: Analyze
        run: dart analyze

      # IMPORTANT: instal·lar lcov ABANS de llegir coverage (si no està present)
      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Test with coverage
        run: flutter test --coverage --coverage-path coverage/lcov.info


      - name: Enforce coverage ≥ 70%
        run: |
          set -euo pipefail
          LCOV="coverage/lcov.info"
          TARGET_DIR="lib/utils/"
          if [ ! -f "$LCOV" ]; then
            echo "::error::Missing $LCOV. Did tests run with --coverage?"
            exit 1
          fi
          awk -v threshold=70 -v target="$TARGET_DIR" '
            BEGIN { hit=0; total=0; in_tgt=0 }
            /^SF:/ {
              in_tgt = (index($0, target) > 0) ? 1 : 0
              next
            }
            in_tgt && /^DA:/ {
              split($0,a,":"); split(a[2],b,",");
              total++
              if (b[2] > 0) hit++
              next
            }
            END {
              if (total==0) {
                printf("Line coverage: 0%%\n")
                printf("No lines found under %s in coverage. Check that tests import package:<app>/... hitting lib/utils/*\n", target)
                exit 1
              }
              pct = (100.0*hit/total)
              printf("Line coverage: %.1f%%\n", pct)
              if (pct + 1e-9 < threshold) {
                printf("Coverage below threshold (%d%%)\n", threshold)
                exit 1
              }
            }' "$LCOV"
