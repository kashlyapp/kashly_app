name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

  # opcional: imprimir versió de Flutter
  #- name: Flutter version
  #  run: flutter --version

      - name: Pub get
        run: flutter pub get

      - name: Analyze
        run: dart analyze

      # IMPORTANT: instal·lar lcov ABANS de llegir coverage (si no està present)
      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Test with coverage
        run: flutter test --coverage


      - name: Enforce coverage ≥ 70%
        env:
          THRESHOLD: 70
        run: |
          set -euo pipefail
          FILE=coverage/lcov.info
          if [ ! -f "$FILE" ]; then
            echo "coverage/lcov.info not found"; echo "Line coverage: 0%"; exit 1
          fi
          # Filtra a lib/ (per no comptar framework)
          awk '
            /^SF:/ {keep = ($0 ~ /\/lib\//); print; next}
            /^DA:/ { if (keep) print; next }
            { print }
          ' "$FILE" > coverage/lcov.lib.info
          FILE=coverage/lcov.lib.info
          total=$(awk -F, '/^DA:/{t++} END{print t+0}' "$FILE")
          covered=$(awk -F, '/^DA:/{if($2>0) c++} END{print c+0}' "$FILE")
          pct=0; if [ "${total:-0}" -gt 0 ]; then pct=$(( 100 * covered / total )); fi
          echo "Line coverage: ${pct}%"
          if [ "$pct" -lt "$THRESHOLD" ]; then
            echo "Coverage below threshold ($THRESHOLD%)"; exit 1
          fi
