name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

  # opcional: imprimir versió de Flutter
  #- name: Flutter version
  #  run: flutter --version

      - name: Pub get
        run: flutter pub get

      - name: Analyze
        run: dart analyze

      # IMPORTANT: instal·lar lcov ABANS de llegir coverage (si no està present)
      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Test with coverage
        run: flutter test --coverage --coverage-path coverage/lcov.info


      - name: Enforce coverage ≥ 70%
        run: |
          set -euo pipefail
          LCOV="coverage/lcov.info"
          if [ ! -f "$LCOV" ]; then
            echo "::error::Missing $LCOV. Did tests run with --coverage?"
            exit 1
          fi
          awk -v threshold=70 '
            BEGIN { hit=0; total=0; inlib=0 }
            /^SF:/ { inlib = ($0 ~ /^SF:lib\// || $0 ~ /\/lib\//) ? 1 : 0; next }
            inlib && /^DA:/ { split($0,a,":"); split(a[2],b,","); total++; if (b[2] > 0) hit++ }
            END {
              if (total==0) { print "Line coverage: 0%"; print "No lines under lib/ found in coverage. Check test imports (package:<app>/...)"; exit 1 }
              pct = (100.0*hit/total)
              printf("Line coverage: %.1f%%\n", pct)
              if (pct + 1e-9 < threshold) { print "Coverage below threshold (" threshold "%)"; exit 1 }
            }' "$LCOV"
