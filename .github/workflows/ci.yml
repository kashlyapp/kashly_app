name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

  # opcional: imprimir versió de Flutter
  #- name: Flutter version
  #  run: flutter --version

      - name: Pub get
        run: flutter pub get

      - name: Analyze
        run: dart analyze

      # IMPORTANT: instal·lar lcov ABANS de llegir coverage (si no està present)
      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Test with coverage
        run: flutter test --coverage --coverage-path coverage/lcov.info

      - name: Debug: print coverage headers
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f coverage/lcov.info ]; then
            echo "::error::Missing coverage/lcov.info"
            exit 1
          fi
          echo "=== SF entries under lib/ (first 80) ==="
          grep -n '^SF:' coverage/lcov.info | sed -n '1,80p' || true
          echo "=== SF entries under lib/utils/ ==="
          grep -n '^SF:.*lib/utils/' coverage/lcov.info || true
          echo "=== First 40 lines of coverage/lcov.info ==="
          sed -n '1,40p' coverage/lcov.info || true

      - name: Enforce coverage ≥ 70% (utils-only, robust awk)
        shell: bash
        run: |
          set -euo pipefail
          LCOV="coverage/lcov.info"
          TARGET="lib/utils/"
          awk -v threshold=70 -v target="$TARGET" '
            BEGIN { hit=0; total=0; files=0; in_tgt=0 }
            /^SF:/ { in_tgt = (index($0, target) > 0); if (in_tgt) files++; next }
            in_tgt && /^DA:/ {
              split($0,a,":"); split(a[2],b,",");
              total++; if (b[2] > 0) hit++;
              next
            }
            END {
              if (files==0) { printf("Line coverage: 0%%\nNo SF under %s\n", target); exit 1 }
              if (total==0) { printf("Line coverage: 0%%\nNo DA lines under %s\n", target); exit 1 }
              pct = (100.0*hit/total);
              printf("Matched files: %d  Lines: %d  Hit: %d\n", files, total, hit);
              printf("Line coverage: %.1f%%\n", pct);
              if (pct + 1e-9 < threshold) { printf("Coverage below threshold (%d%%)\n", threshold); exit 1 }
            }' "$LCOV"
